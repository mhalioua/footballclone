<div class="dateselect" style="text-align: center;">
	<input type="text" data-toggle="daterangepicker" maxlength="23" name="timestamp" data-filter-type="date-range" style="width: 250px;" class="daterange">  
    <button class="btn btn-primary prevbutton">Prev</button>
    <button class="btn btn-primary nextbutton">Next</button>
</div>
<script type="text/javascript">
	var start = moment("<%= @game_start_index %>").format('MMM DD, YYYY');
	var end = moment("<%= @game_end_index %>").format('MMM DD, YYYY') ;
	$('.daterange').daterangepicker({
		showDropdowns: true,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Next 7 Days': [moment(), moment().add(6, 'days')],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'Last 60 Days': [moment().subtract(59, 'days'), moment()],
           'Last 90 Days': [moment().subtract(89, 'days'), moment()],
           'Last 180 Days': [moment().subtract(179, 'days'), moment()],
           'This Week': [moment().startOf('week'), moment().endOf('week')],
           'Last Week': [moment().subtract(1, 'week').startOf('week'), moment().subtract(1, 'week').endOf('week')],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
           'This Year': [moment().startOf('year'), moment().endOf('year')],
           'Last Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')]
        },
        locale: {
			format: 'MMM DD, YYYY'
		},
        startDate: start,
        endDate: end,
    }, cb);
    function cb(start, end) {
    	window.location.href = "/welcome/index/" + start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD');
    }
    $('.prevbutton').click(function(){
        var start = moment("<%= @game_start_index %>").subtract(1, 'days');
		var end = moment("<%= @game_end_index %>").subtract(1, 'days');
		$('.daterange').val(start.format('MMM DD, YYYY') + ' - ' + end.format('MMM DD, YYYY'));
        window.location.href = "/welcome/index/" + start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD');
    }); 
    $('.nextbutton').click(function(){
        var start = moment("<%= @game_start_index %>").add(1, 'days');
		var end = moment("<%= @game_end_index %>").add(1, 'days');
		$('.daterange').val(start.format('MMM DD, YYYY') + ' - ' + end.format('MMM DD, YYYY'));
        window.location.href = "/welcome/index/" + start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD');
    });
</script>

<div class="main">
	<table class="game-index" border="1">
  		<thead style="font-size: 0.7em">
  			<tr>
  				<th width="40"></th>
  				<th width="90"></th>
  				<th width="200"></th>
  				<th width="30"></th>
  				<th width="50"></th>
  				<th width="50"></th>
  				<th width="50"></th>
  				<th width="50"></th>
  				<th width="150"></th>
  				<th width="170"></th>
  				<th colspan="11">1st Half</th>
  				<th colspan="2">Drives</th>
  				<th width="30"></th>
  			</tr>
  			<tr>
  				<th width="40">Game #</th>
  				<th width="90">Start Time</th>
  				<th width="200">MATCH-UPS</th>
  				<th width="30">1H score</th>
  				<th width="50">Time</th>
  				<th width="50">Count Down</th>
  				<th width="50">1H Total yards</th>
  				<th width="50">1H Rushing yards</th>
  				<th width="150">KICKED</th>
  				<th>FULL GAME <br> 2ND HALF LINES</th>
  				<th>CAR</th>
  				<th>AVE <br> CAR</th>
  				<th>TYPC</th>
  				<th>C/ATT</th>
  				<th>AVE <br> ATT</th>
  				<th>TYPA</th>
  				<th>TOTAL <br> PLAYS</th>
  				<th>TOTAL <br> PLAYS/ <br> YARDS</th>
  				<th>TYPP</th>
  				<th>LONGEST <br> PASS</th>
  				<th>LONGEST <br> RUSH</th>
  				<th>1st Half</th>
  				<th>2nd Half</th>
  				<th width="30">FG score</th>
  			</tr>
  		</thead>
		<tbody>
		<% @games.each_with_index do |game, index| %>
		<%
			color = "royalblue"
			if index % 2 == 1
				color = "dodgerblue"
			end
			game_state = game.game_state.to_i

			if game_state == 4
				color = "rgb(156,225,104)"
				if index % 2 == 1
					color = "rgb(147,213,186)"
				end
			elsif game_state == 1 || game_state == 2
				color = "lightyellow"
				if index % 2 == 1
					color = "yellow"
				end
			elsif game_state == 0
				color = "red"
				if index % 2 == 1
					color = "palevioletred"
				end
			elsif game_state == 3
				color = "orange"
				if index % 2 == 1
					color = "orangered"
				end
			end
			style = "background:#{color}"
			away_team_total = ""
			away_team_rushing = ""
			home_team_total = ""
			home_team_rushing = ""
			home_result = ""
			away_result = ""
			game_status = ""

			home_car = ""
    		ome_ave_car = ""
    		home_pass_long = ""
    		home_rush_long = ""
    		home_c_att = ""
    		home_ave_att = ""
    		home_total_play = ""
    		home_play_yard = ""
    		home_sacks = ""
    		away_car = ""
    		away_ave_car = ""
    		away_pass_long = ""
    		away_rush_long = ""
    		away_c_att = ""
    		away_ave_att = ""
    		away_total_play = ""
    		away_play_yard = ""
    		away_sacks = ""

			home_typc = ""
			home_typa = ""
			away_typc = ""
			away_typa = ""

			score = game.scores.find_by(result: "Half")
			if score
				home_team_total = score.home_team_total
				away_team_total = score.away_team_total
				away_team_rushing = score.away_team_rushing
				home_team_rushing = score.home_team_rushing
				home_result = score.home_result
				away_result = score.away_result
				game_status = score.game_status
				if game.game_state == 3 || game.game_state == 5 || game.game_state == 6
					game_status = "-"
				end
				if game_status.size > 0 && game_status[0] == "0"
					game_status.slice!(0)
				end

				home_car = score.home_car
    			home_ave_car = score.home_ave_car
    			home_pass_long = score.home_pass_long
    			home_rush_long = score.home_rush_long
    			home_c_att = score.home_c_att
    			home_ave_att = score.home_ave_att
    			home_total_play = score.home_total_play
    			home_play_yard = score.home_play_yard
    			if home_play_yard != ""
    				home_play_yard_index = home_play_yard.index(".")
    				home_play_yard = home_play_yard_index ? home_play_yard[0..home_play_yard_index+2] : ""
    			end
    			away_car = score.away_car
    			away_ave_car = score.away_ave_car
    			away_pass_long = score.away_pass_long
    			away_rush_long = score.away_rush_long
    			away_c_att = score.away_c_att
    			away_ave_att = score.away_ave_att
    			away_total_play = score.away_total_play
    			away_play_yard = score.away_play_yard
    			if away_play_yard != ""
    				away_play_yard_index = away_play_yard.index(".")
    				away_play_yard = away_play_yard_index ? away_play_yard[0..away_play_yard_index+2] : ""
    			end

    			if  home_total_play.to_i > 2 && home_pass_long && home_rush_long && home_play_yard
    				home_sacks = ((home_team_total.to_i - home_pass_long.to_i - home_rush_long.to_i).to_f / (home_total_play.to_i - 2)).round(2)
    			end

    			if home_car.to_i > 1 && home_team_rushing && home_rush_long
                    home_typc = ((home_team_rushing.to_i - home_rush_long.to_i).to_f / (home_car.to_i - 1))
                    home_typc = home_typc.round(2)
                end
                

               	home_att_index = home_c_att.index("/")
               	home_att = home_att_index ? home_c_att[home_att_index+1..-1].to_i : 0
               	if home_att > 1 && home_team_rushing && home_pass_long
               		home_typa = ((home_team_total.to_i - home_team_rushing.to_i - home_pass_long.to_i).to_f / (home_att - 1))
               		home_typa = home_typa.round(2)
               	end
               	

    			if  away_total_play.to_i > 2 && away_pass_long && away_rush_long && away_play_yard
    				away_sacks = ((away_team_total.to_i - away_pass_long.to_i - away_rush_long.to_i).to_f / (away_total_play.to_i - 2)).round(2)
    			end

    			if away_car.to_i > 1 && away_team_rushing && away_rush_long
                    away_typc = ((away_team_rushing.to_i - away_rush_long.to_i).to_f / (away_car.to_i - 1))
                	away_typc = away_typc.round(2)
                end

                away_att_index = away_c_att.index("/")
               	away_att = away_att_index ? away_c_att[away_att_index+1..-1].to_i : 0
               	if away_att > 1 && away_team_rushing && away_pass_long
               		away_typa = ((away_team_total.to_i - away_team_rushing.to_i - away_pass_long.to_i).to_f / (away_att - 1))
               		away_typa = away_typa.round(2)
               	end

			end
			home_full = ""
			away_full = ""
			full = game.scores.find_by(result: "Final")
			if full
				home_full = full.home_result
				away_full = full.away_result
			end
			f_min = ""
			if game_state == 0
				diff = (DateTime.parse(game.game_status) + 15.minutes).to_i - Time.now.to_i
				if diff > 0
					f_min = (diff / 60).to_s + ":"
					if (diff % 60) < 10
						f_min = f_min + "0"
					end
					f_min = f_min + (diff % 60).to_s
				end
			end

			if game_state == 6
				home_result = game.game_status
				away_result = game.game_status
			end
			pinnacle = ""
			if game.home_pinnacle
				home_pinnacle = game.home_pinnacle
				away_pinnacle = game.away_pinnacle
				if home_pinnacle[0] != "-"
					temp = home_pinnacle
					home_pinnacle = away_pinnacle
					away_pinnacle = temp
				end
				index = home_pinnacle.index(" ")
				pinnacle = index ? home_pinnacle[0..index-1] : ""
				index = away_pinnacle.index(" ")
				if index
					if pinnacle != ""
						pinnacle = pinnacle + " and "
					end
					pinnacle = pinnacle + away_pinnacle[0..index-1]
				end
			end
			if pinnacle != ""
				if game.home_pinnacle[0] == "-"
					pinnacle = game.home_abbr + " was " + pinnacle
				else
					pinnacle = game.away_abbr + " was " + pinnacle
				end
			end
			second_pinnacle = ""
			if game.home_2nd_pinnacle
				home_2nd_pinnacle = game.home_2nd_pinnacle
				away_2nd_pinnacle = game.away_2nd_pinnacle
				if home_2nd_pinnacle[0] != "-"
					temp = home_2nd_pinnacle
					home_2nd_pinnacle = away_2nd_pinnacle
					away_2nd_pinnacle = temp
				end
				index = home_2nd_pinnacle.index(" ")
				second_pinnacle = index ? home_2nd_pinnacle[0..index-1] : ""
				index = away_2nd_pinnacle.index(" ")
				if index
					if second_pinnacle != ""
						second_pinnacle = second_pinnacle + " and "
					end
					second_pinnacle = second_pinnacle + away_2nd_pinnacle[0..index-1]
				end
			end
			if second_pinnacle != ""
				if game.home_2nd_pinnacle[0] == "-"
					second_pinnacle = game.home_abbr + " was " + second_pinnacle
				else
					second_pinnacle = game.away_abbr + " was " + second_pinnacle
				end
			end

			first_drive = ""
			second_drive = ""
			first_drive = game.first_drive.to_s
			if game_state == 5
				first_drive = game.first_drive.to_s
				second_drive = (game.second_drive.to_i - game.first_drive.to_i).to_s
			end
			bluedark =""
			if game_state == 5 
				bluedark = "background:#44e;"
			end
			darkcolor = ""
			if game_state == 0
				darkcolor = "background:darkred;"
			end
			
			sep_style = "border-left:9px;border-left-style:solid;border-left-color:black;"
		%>
			<tr style=<%= style %> >
				<td class="borderTop"><%= game.away_number %></td>
				<% game_date = game.game_date.strftime("%b %e, %Y %l:%M %P") %>
				<td rowspan="2" class="borderTop"><%= game_date %></td>
				<td class="borderTop"><%= game.away_team %></td>
				<td class="borderTop"><%= away_result %></td>
				<td rowspan="2" class="borderTop"><%= game_status %></td>
				<td rowspan="2" class="borderTop main-time" ><%= f_min %></td>
				<td class="borderTop"><%= away_team_total %></td>
				<td class="borderTop"><%= away_team_rushing %></td>
				<%
					if game.kicked == "home"
				%>
					<td rowspan="2" class="borderTop" style = "text-transform: uppercase"> <%= game.home_team %> <br> kicked</td>
				<%
					elsif game.kicked == "away"
				%>
					<td rowspan="2" class="borderTop" style = "text-transform: uppercase"> <%= game.away_team %> <br> kicked</td>
				<%
					else
				%>
					<td rowspan="2" class="borderTop" style = "text-transform: uppercase"></td>
				<%
					end
				%>
				<td class="borderTop"><%= pinnacle %></td>
				<td class="borderTop" style=<%= sep_style %> ><%= away_car %></td>
				<td class="borderTop" style=<%= darkcolor %> ><%= away_ave_car %></td>
				<td class="borderTop" style=<%= bluedark %> ><%= away_typc %></td>
				<td class="borderTop" style=<%= sep_style %> ><%= away_c_att %></td>
				<td class="borderTop" style=<%= darkcolor %> ><%= away_ave_att %></td>
				<td class="borderTop" style=<%= bluedark %> ><%= away_typa %></td>
				<td class="borderTop" style=<%= sep_style %> ><%= away_total_play %></td>
				<td class="borderTop" style=<%= darkcolor %> ><%= away_play_yard %></td>
				<td class="borderTop" style=<%= bluedark %> ><%= away_sacks %></td>
				<td class="borderTop" style=<%= sep_style %> ><%= away_pass_long %></td>
				<td class="borderTop" ><%= away_rush_long %></td>
				<td rowspan="2" class="borderTop"><%= first_drive %></td>
				<td rowspan="2" class="borderTop"><%= second_drive %></td>
				<td class="borderTop"><%= away_full %></td>
			</tr>
			<tr style=<%= style %> >
				<td><%= game.home_number %></td>
				<td><%= game.home_team %></td>
				<td><%= home_result %></td>
				<td><%= home_team_total %></td>
				<td><%= home_team_rushing %></td>
				<td><%= second_pinnacle %></td>
				<td style=<%= sep_style %> ><%= home_car %></td>
				<td style=<%= darkcolor %> ><%= home_ave_car %></td>
				<td style=<%= bluedark %> ><%= home_typc %></td>
				<td style=<%= sep_style %> ><%= home_c_att %></td>
				<td style=<%= darkcolor %> ><%= home_ave_att %></td>
				<td style=<%= bluedark %> ><%= home_typa %></td>
				<td style=<%= sep_style %> ><%= home_total_play %></td>
				<td style=<%= darkcolor %> ><%= home_play_yard %></td>
				<td style=<%= bluedark %> ><%= home_sacks %></td>
				<td style=<%= sep_style %> ><%= home_pass_long %></td>
				<td><%= home_rush_long %></td>
				<td><%= home_full %></td>
			</tr>
		<% end %>
		</tbody>
	</table>
</div>

<script>
setInterval(repeat, 1000)
function repeat() {
	var list = $(".main-time")
	for (var i = 0; i < list.length ; i++) {
		var value = list[i].innerHTML
		if (value !="") {
			var se_index = value.indexOf(":")
			min = parseInt(value.substring(0, se_index))
			sec = parseInt(value.substring(se_index+1, value.length+1))
			var time = min * 60 + sec - 1;
			if (time == 0)
				list[i].innerHTML = ""
			else
				list[i].innerHTML = Math.floor(time/60) + ":" + ("0" + time%60).slice(-2)
		}
	}
}
</script>